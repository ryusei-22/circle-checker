</html><!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Circle Checker Pro">
    <title>Circle Checker Pro - 修正版</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            overscroll-behavior: none;
            touch-action: manipulation;
        }
        canvas { touch-action: none; }
        .touch-none { touch-action: none; }
        
        @media (display-mode: standalone) {
            body { padding-top: env(safe-area-inset-top); }
        }
        
        .warning-pulse {
            animation: warningPulse 2s infinite;
        }
        
        @keyframes warningPulse {
            0%, 100% { background-color: rgba(239, 68, 68, 0.1); }
            50% { background-color: rgba(239, 68, 68, 0.3); }
        }

        .accurate-indicator {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(34, 197, 94, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // 元のExcelデータ
        const EXCEL_DATA = [
            {"判断円":"親円","タイプ":"ガイディングカテ","名称":"5Fr","最大外径":1.5},
            {"判断円":"親円","タイプ":"ガイディングカテ","名称":"6Fr","最大外径":1.8},
            {"判断円":"親円","タイプ":"ガイディングカテ","名称":"7Fr","最大外径":2.06},
            {"判断円":"親円","タイプ":"ガイディングカテ","名称":"8Fr","最大外径":2.28},
            {"判断円":"親円","タイプ":"ガイドエクステンション","名称":"EZ Guide　5.5Fr ","最大外径":1.3},
            {"判断円":"親円","タイプ":"ガイドエクステンション","名称":"EZ Guide　6Fr","最大外径":1.42},
            {"判断円":"親円","タイプ":"ガイドエクステンション","名称":"GUIDE PLUS 5Fr","最大外径":1.19},
            {"判断円":"親円","タイプ":"ガイドエクステンション","名称":"GUIDE PLUS ⅡST　６Fr","最大外径":1.33},
            {"判断円":"親円","タイプ":"ガイドエクステンション","名称":"HIKYAKU","最大外径":1.48},
            {"判断円":"子円","タイプ":"バルーン〔SC〕","名称":"Ryurei【1.00-1.50mm】","最大外径":0.89,"シャフト径":0.64},
            {"判断円":"子円","タイプ":"バルーン〔SC〕","名称":"Ryurei【2.00-4.00mm】","最大外径":0.87,"シャフト径":0.64},
            {"判断円":"子円","タイプ":"バルーン〔SC〕","名称":"ZINRAI【0.75-1.00mm】","最大外径":0.87,"シャフト径":0.65},
            {"判断円":"子円","タイプ":"バルーン〔SC〕","名称":"ZINRAI【1.50-2.50mm】","最大外径":0.84,"シャフト径":0.6},
            {"判断円":"子円","タイプ":"バルーン〔SC〕","名称":"Regnam【2.00-3.00mm】","最大外径":0.83,"シャフト径":0.7},
            {"判断円":"子円","タイプ":"バルーン〔SC〕","名称":"Euphora【1.5-3.00mm】","最大外径":0.84,"シャフト径":0.69},
            {"判断円":"子円","タイプ":"バルーン〔SC〕","名称":"MINI TREK【2.00mm】","最大外径":0.76,"シャフト径":0.69},
            {"判断円":"子円","タイプ":"バルーン〔SC〕","名称":"TREK【2.50-3.50mm】","最大外径":0.81,"シャフト径":0.69},
            {"判断円":"子円","タイプ":"バルーン〔NC〕","名称":"NC Kamui【2.50-3.50mm】","最大外径":0.83,"シャフト径":0.7},
            {"判断円":"子円","タイプ":"バルーン〔NC〕","名称":"NC Kamui【3.75-4.50mm】","最大外径":0.87,"シャフト径":0.7},
            {"判断円":"子円","タイプ":"バルーン〔NC〕","名称":"Powered3 NC【2.50mm】","最大外径":0.81,"シャフト径":0.69,"備考":"適応GC :6Fr  デフレ時、上手く畳まれないと5Frだと抜けない可能性あり"},
            {"判断円":"子円","タイプ":"バルーン〔NC〕","名称":"Powered3 NC【2.75-3.50mm】","最大外径":0.83,"シャフト径":0.69,"備考":"適応GC :6Fr  デフレ時、上手く畳まれないと5Frだと抜けない可能性あり"},
            {"判断円":"子円","タイプ":"バルーン〔NC〕","名称":"Powered3 NC【3.75-4.00mm】","最大外径":0.86,"シャフト径":0.69,"備考":"適応GC :6Fr  デフレ時、上手く畳まれないと5Frだと抜けない可能性あり"},
            {"判断円":"子円","タイプ":"バルーン〔NC〕","名称":"Hiryu Plus【2.00-4.00mm】","最大外径":0.87,"シャフト径":0.64},
            {"判断円":"子円","タイプ":"バルーン〔NC〕","名称":"Hiryu Plus【4.00-5.00mm】","最大外径":0.87,"シャフト径":0.64,"備考":"適応GC :6Fr  GC/MID(mm): 1.78 "},
            {"判断円":"子円","タイプ":"バルーン〔NC〕","名称":"Hiryu IB【1.25mm】","最大外径":0.87,"シャフト径":0.64},
            {"判断円":"子円","タイプ":"バルーン〔その他〕","名称":"Sequent Please NEO 【2.00-3.50mm】","最大外径":0.83,"シャフト径":0.63,"備考":"※バルーンは5Fr対応だが、drugが剥がれるおそれがあるため、GC/MID(mm):1.65を大きくしている"},
            {"判断円":"子円","タイプ":"バルーン〔その他〕","名称":"Aperta NSE【2.00-3.50mm】","最大外径":0.86,"シャフト径":0.68},
            {"判断円":"子円","タイプ":"バルーン〔その他〕","名称":"kIZASHI【2.0-3.00mm】","最大外径":0.99,"シャフト径":0.7},
            {"判断円":"子円","タイプ":"バルーン〔その他〕","名称":"kIZASHI【3.50-mm】","最大外径":0.99,"シャフト径":0.7,"備考":"適応GC :6Fr  GC/MID(mm): 1.78 "},
            {"判断円":"子円","タイプ":"バルーン〔その他〕","名称":"Wolverine【2.00-3.00mm】","最大外径":0.91,"シャフト径":0.59},
            {"判断円":"子円","タイプ":"バルーン〔NC〕","名称":"Ace HP【2.50-3.00mm】","最大外径":0.8,"シャフト径":0.66},
            {"判断円":"子円","タイプ":"バルーン〔NC〕","名称":"Ace HP【3.50-4.00mm】","最大外径":0.86,"シャフト径":0.66},
            {"判断円":"子円","タイプ":"バルーン〔NC〕","名称":"NC Euphora【2.25-3.50mm】","最大外径":0.89,"シャフト径":0.69},
            {"判断円":"子円","タイプ":"バルーン〔その他〕","名称":"Ryusei【2.50-3.50mm】","最大外径":1.13},
            {"判断円":"子円","タイプ":"ステント","名称":"Xience Skypoint-38mm【2.25-4.0mm】","最大外径":0.93,"シャフト径":0.71},
            {"判断円":"子円","タイプ":"ステント","名称":"Xience Skypoint-48mm【2.25-4.0mm】","最大外径":0.93,"シャフト径":0.71,"備考":"適応GC :6Fr  GC/MID(mm): 1.78 "},
            {"判断円":"子円","タイプ":"ステント","名称":"Resolute【2.25-3.5mm】","最大外径":0.91,"シャフト径":0.69},
            {"判断円":"子円","タイプ":"ステント","名称":"Coroflex ISAR NEO【2.5-3.5mm】","最大外径":0.83,"シャフト径":0.63},
            {"判断円":"子円","タイプ":"ステント","名称":"Orsiro Mission【2.25-3.0mm】","最大外径":0.89,"シャフト径":0.66},
            {"判断円":"子円","タイプ":"ステント","名称":"Orsiro Mission【3.50mm】","最大外径":0.96,"シャフト径":0.66},
            {"判断円":"子円","タイプ":"ステント","名称":"BioFreedom Ultra【2.5-4.0mm】","最大外径":0.86,"シャフト径":0.7},
            {"判断円":"子円","タイプ":"マイクロカテーテル","名称":"Caravel MC","最大外径":0.85},
            {"判断円":"子円","タイプ":"マイクロカテーテル","名称":"Zizai","最大外径":0.94},
            {"判断円":"子円","タイプ":"マイクロカテーテル","名称":"Mogul SP　Thinner","最大外径":0.87},
            {"判断円":"子円","タイプ":"マイクロカテーテル","名称":"Mogul SP","最大外径":0.87},
            {"判断円":"子円","タイプ":"マイクロカテーテル","名称":"MITICHIBIKI PLUS","最大外径":0.94},
            {"判断円":"子円","タイプ":"マイクロカテーテル","名称":"Fine Cross GT","最大外径":0.87},
            {"判断円":"子円","タイプ":"マイクロカテーテル","名称":"carry Leon UX19","最大外径":0.63},
            {"判断円":"子円","タイプ":"マイクロカテーテル","名称":"Corsair Pro","最大外径":0.93},
            {"判断円":"子円","タイプ":"マイクロカテーテル","名称":"Corsair Pro XS","最大外径":0.95},
            {"判断円":"子円","タイプ":"マイクロカテーテル","名称":"Crusade type R","最大外径":1.06},
            {"判断円":"子円","タイプ":"マイクロカテーテル","名称":"SASUKE","最大外径":1.05},
            {"判断円":"子円","タイプ":"末梢保護","名称":"PARACHUTE","最大外径":0.36},
            {"判断円":"子円","タイプ":"末梢保護","名称":"FILTRAPⅡ","最大外径":0.89},
            {"判断円":"子円","タイプ":"交換用カテーテル","名称":"KUSABI","最大外径":0.68},
            {"判断円":"子円","タイプ":"交換用カテーテル","名称":"EZ Keeper","最大外径":0.68},
            {"判断円":"子円","タイプ":"FFRワイヤー","名称":"Comet Ⅱ","最大外径":0.36},
            {"判断円":"子円","タイプ":"IVUS","名称":"OptiCross","最大外径":1.05},
            {"判断円":"子円","タイプ":"血栓吸引","名称":"ThrombusterⅡ 6Fr","最大外径":1.3},
            {"判断円":"子円","タイプ":"血栓吸引","名称":"ThrombusterⅡ 7Fr","最大外径":1.52},
            {"判断円":"子円","タイプ":"血栓吸引","名称":"ThrombusterⅡ 8Fr","最大外径":1.74},
            {"判断円":"子円","タイプ":"その他","名称":"Snare Kit","最大外径":1.35},
            {"判断円":"子円","タイプ":"ガイドワイヤー","名称":"1.4Wire","最大外径":0.36},
            {"判断円":"子円","タイプ":"ガイドワイヤー","名称":"RG３","最大外径":0.26},
            {"判断円":"子円","タイプ":"ガイドエクステンション","名称":"EZ Guide　5.5Fr ","最大外径":1.3},
            {"判断円":"子円","タイプ":"ガイドエクステンション","名称":"EZ Guide　6Fr","最大外径":1.42},
            {"判断円":"子円","タイプ":"ガイドエクステンション","名称":"GUIDE PLUS 5Fr","最大外径":1.19},
            {"判断円":"子円","タイプ":"ガイドエクステンション","名称":"GUIDE PLUS ⅡST　６Fr","最大外径":1.33}
        ];

        // 設定 - ズーム機能を削除し、固定スケール
        const CANVAS_SIZE = 400;
        const BASE_SCALE_FACTOR = 150; // 固定スケール
        const MIN_VISIBLE_RADIUS = 1; // 最小表示半径
        
        // クリアランス設定
        const CLEARANCE_SETTINGS = {
            SAFE: 0.15,     // 安全（緑）
            WARNING: 0.05,  // 注意（黄）
            DANGER: 0.0     // 危険（赤）
        };

        const CircleCheckerPro = () => {
            const [activeTab, setActiveTab] = useState('setup');
            
            // データベースの初期化とlocalStorageからの読み込み
            const [database, setDatabase] = useState(() => {
                try {
                    const savedData = localStorage.getItem('circleCheckerDatabase');
                    if (savedData) {
                        const parsed = JSON.parse(savedData);
                        if (Array.isArray(parsed) && parsed.length > 0) {
                            console.log('💾 保存されたデータベースを読み込みました:', parsed.length + '件');
                            return parsed;
                        }
                    }
                } catch (error) {
                    console.warn('⚠️ 保存データの読み込みに失敗しました:', error);
                }
                console.log('📋 初期データベースを使用します');
                return EXCEL_DATA;
            });
            
            const [parentCircles, setParentCircles] = useState([]);
            const [childCirclesData, setChildCirclesData] = useState([]);
            const [selectedParent, setSelectedParent] = useState(null);
            const [selectedType, setSelectedType] = useState('');
            const [selectedName, setSelectedName] = useState('');
            const [selectedPattern, setSelectedPattern] = useState('pattern1');
            const [childCircles, setChildCircles] = useState([]);
            const [selectedCircleIndex, setSelectedCircleIndex] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const canvasRef = useRef(null);

            const [dragState, setDragState] = useState({
                isDragging: false,
                dragIndex: null,
                startPos: { x: 0, y: 0 }
            });

            // データベース管理機能
            const [newDeviceForm, setNewDeviceForm] = useState({
                判断円: '子円',
                タイプ: '',
                名称: '',
                最大外径: '',
                シャフト径: '',
                備考: ''
            });
            const [showAddForm, setShowAddForm] = useState(false);
            const [editingIndex, setEditingIndex] = useState(null);
            const [editForm, setEditForm] = useState({});

            // データベースが変更されるたびにlocalStorageに保存
            useEffect(() => {
                try {
                    localStorage.setItem('circleCheckerDatabase', JSON.stringify(database));
                    console.log('💾 データベースを保存しました:', database.length + '件');
                } catch (error) {
                    console.error('❌ データベースの保存に失敗しました:', error);
                }
            }, [database]);

            // 固定スケール計算（ズーム機能削除）
            const getScaleFactor = () => BASE_SCALE_FACTOR;

            // クリアランス計算関数
            const calculateClearance = (parentDiameter, childDiameter) => {
                return parentDiameter - childDiameter;
            };

            // クリアランス状態を判定
            const getClearanceStatus = (clearance) => {
                if (clearance >= CLEARANCE_SETTINGS.SAFE) return 'SAFE';
                if (clearance >= CLEARANCE_SETTINGS.WARNING) return 'WARNING';
                return 'DANGER';
            };

            // 適合性をチェック
            const checkCompatibility = (parentCircle, childCircle, pattern) => {
                if (!parentCircle || !childCircle) return { status: 'SAFE', clearance: 0, message: '' };
                
                const childSize = pattern === 'pattern1' ? childCircle.最大外径 : (childCircle.シャフト径 || childCircle.最大外径);
                const clearance = calculateClearance(parentCircle.最大外径, childSize);
                const status = getClearanceStatus(clearance);
                
                let message = '';
                if (status === 'DANGER') {
                    if (clearance <= 0) {
                        message = '⚠️ 理論上挿入不可能';
                    } else {
                        message = '⚠️ クリアランス不足';
                    }
                } else if (status === 'WARNING') {
                    message = '⚠️ 注意が必要';
                } else {
                    message = '✅ 安全';
                }
                
                return { status, clearance, message };
            };

            // 重なり検出を改善（より正確な計算）
            const detectOverlaps = (circles, currentIndex = -1) => {
                const scaleFactor = getScaleFactor();
                const centerX = CANVAS_SIZE / 2;
                const centerY = CANVAS_SIZE / 2;
                const parentRadius = selectedParent ? Math.min((selectedParent.最大外径 * scaleFactor) / 2, (CANVAS_SIZE / 2) - 20) : 0;

                return circles.map((circle, index) => {
                    const radius = Math.max(MIN_VISIBLE_RADIUS, (circle.activeSize * scaleFactor) / 2);
                    
                    // 親円からのはみ出しチェック
                    const distanceFromCenter = Math.sqrt((circle.x - centerX) ** 2 + (circle.y - centerY) ** 2);
                    const isOutsideParent = selectedParent && parentRadius > 0 && (distanceFromCenter + radius > parentRadius);

                    // 他の円との重なりチェック（より寛容な条件）
                    let hasCircleOverlap = false;
                    for (let j = 0; j < circles.length; j++) {
                        if (index === j) continue;
                        const other = circles[j];
                        const otherRadius = Math.max(MIN_VISIBLE_RADIUS, (other.activeSize * scaleFactor) / 2);
                        const dx = circle.x - other.x;
                        const dy = circle.y - other.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        // 重なり判定を少し緩く（1px余裕を持たせる）
                        if (distance < radius + otherRadius - 2) {
                            hasCircleOverlap = true;
                            break;
                        }
                    }

                    return {
                        ...circle,
                        isOutsideParent,
                        hasCircleOverlap,
                        compatibility: checkCompatibility(selectedParent, circle, circle.pattern)
                    };
                });
            };

            // データベース初期化
            useEffect(() => {
                const parents = database.filter(item => item['判断円'] === '親円');
                const children = database.filter(item => item['判断円'] === '子円');
                setParentCircles(parents);
                setChildCirclesData(children);
                
                if (parents.length > 0) {
                    setSelectedParent(parents[0]);
                }
            }, [database]);

            // キャンバス初期化
            useEffect(() => {
                if (canvasRef.current) {
                    canvasRef.current.width = CANVAS_SIZE;
                    canvasRef.current.height = CANVAS_SIZE;
                }
            }, []);

            // キャンバス描画
            useEffect(() => {
                if (activeTab === 'canvas') {
                    const timer = setTimeout(() => {
                        drawCanvas();
                    }, 100);
                    return () => clearTimeout(timer);
                }
            }, [activeTab]);

            useEffect(() => {
                drawCanvas();
            }, [selectedParent, childCircles, selectedCircleIndex]);

            const drawCanvas = () => {
                const canvas = canvasRef.current;
                if (!canvas) return;

                if (canvas.width !== CANVAS_SIZE || canvas.height !== CANVAS_SIZE) {
                    canvas.width = CANVAS_SIZE;
                    canvas.height = CANVAS_SIZE;
                }

                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                const scaleFactor = getScaleFactor();

                // 親円描画
                if (selectedParent) {
                    const centerX = CANVAS_SIZE / 2;
                    const centerY = CANVAS_SIZE / 2;
                    const radius = (selectedParent.最大外径 * scaleFactor) / 2;

                    // 親円が画面に収まるかチェック
                    const maxRadius = (CANVAS_SIZE / 2) - 20;
                    const displayRadius = Math.min(radius, maxRadius);
                    const isParentClipped = radius > maxRadius;

                    ctx.beginPath();
                    ctx.arc(centerX, centerY, displayRadius, 0, Math.PI * 2);
                    ctx.strokeStyle = isParentClipped ? '#ff6b35' : '#8E8E93';
                    ctx.lineWidth = isParentClipped ? 4 : 3;
                    if (isParentClipped) {
                        ctx.setLineDash([10, 5]);
                    }
                    ctx.stroke();
                    ctx.setLineDash([]);
                    
                    // ラベル
                    ctx.fillStyle = '#1D1D1F';
                    ctx.font = 'bold 14px -apple-system, BlinkMacSystemFont, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(
                        `${selectedParent.名称} (${selectedParent.最大外径}mm)`, 
                        centerX, 
                        centerY - displayRadius - 15
                    );
                    
                    if (isParentClipped) {
                        ctx.fillStyle = '#ff6b35';
                        ctx.font = '10px -apple-system, BlinkMacSystemFont, sans-serif';
                        ctx.fillText('⚠️ 親円がクリップされています', centerX, centerY - displayRadius - 30);
                    }
                }

                // 重なり検出を実行
                const circlesWithOverlapInfo = detectOverlaps(childCircles);

                // 子円描画（重なり検出結果を反映）
                circlesWithOverlapInfo.forEach((circle, index) => {
                    const radius = Math.max(MIN_VISIBLE_RADIUS, (circle.activeSize * scaleFactor) / 2);
                    
                    ctx.beginPath();
                    ctx.arc(circle.x, circle.y, radius, 0, Math.PI * 2);

                    // 色設定（重なり検出結果を優先）
                    if (circle.isOutsideParent) {
                        ctx.fillStyle = 'rgba(255, 59, 48, 0.6)'; // 濃い赤：親円からはみ出し
                    } else if (circle.hasCircleOverlap) {
                        ctx.fillStyle = 'rgba(255, 152, 0, 0.6)'; // オレンジ：子円同士の重なり
                    } else if (circle.compatibility.status === 'DANGER') {
                        ctx.fillStyle = 'rgba(255, 59, 48, 0.4)'; // 薄い赤：適合性危険
                    } else if (circle.compatibility.status === 'WARNING') {
                        ctx.fillStyle = 'rgba(245, 158, 11, 0.4)'; // 黄色：適合性注意
                    } else {
                        ctx.fillStyle = circle.pattern === 'pattern1' ? 'rgba(0, 122, 255, 0.4)' : 'rgba(52, 199, 89, 0.4)'; // 青/緑：正常
                    }

                    ctx.fill();
                    
                    // 境界線
                    if (index === selectedCircleIndex) {
                        ctx.strokeStyle = '#FF3B30';
                        ctx.lineWidth = 4;
                    } else if (circle.isOutsideParent || circle.hasCircleOverlap) {
                        ctx.strokeStyle = '#FF3B30';
                        ctx.lineWidth = 3;
                    } else if (circle.compatibility.status === 'DANGER') {
                        ctx.strokeStyle = '#ef4444';
                        ctx.lineWidth = 3;
                    } else if (circle.compatibility.status === 'WARNING') {
                        ctx.strokeStyle = '#f59e0b';
                        ctx.lineWidth = 3;
                    } else {
                        ctx.strokeStyle = '#8E8E93';
                        ctx.lineWidth = 2;
                    }
                    
                    // 極小の場合は点線で表示
                    const theoreticalRadius = (circle.activeSize * scaleFactor) / 2;
                    if (theoreticalRadius < MIN_VISIBLE_RADIUS * 2) {
                        ctx.setLineDash([3, 3]);
                    } else {
                        ctx.setLineDash([]);
                    }
                    ctx.stroke();
                    ctx.setLineDash([]);

                    // ラベル（サイズに応じて調整）
                    if (radius > 8) {
                        ctx.fillStyle = '#1D1D1F';
                        const fontSize = Math.max(8, Math.min(12, radius / 3));
                        ctx.font = `bold ${fontSize}px -apple-system, BlinkMacSystemFont, sans-serif`;
                        ctx.textAlign = 'center';
                        
                        const shortName = circle.名称.split('【')[0].substring(0, Math.max(4, Math.floor(radius / 5)));
                        ctx.fillText(shortName, circle.x, circle.y + 2);
                        
                        // サイズ表示
                        if (radius > 12) {
                            ctx.font = `${fontSize - 2}px -apple-system, BlinkMacSystemFont, sans-serif`;
                            ctx.fillText(`${circle.activeSize}mm`, circle.x, circle.y + fontSize + 2);
                        }
                        
                        // 極小サイズの警告
                        if (theoreticalRadius < MIN_VISIBLE_RADIUS * 2) {
                            ctx.fillStyle = '#ff6b35';
                            ctx.font = '8px -apple-system, BlinkMacSystemFont, sans-serif';
                            ctx.fillText('拡大表示', circle.x, circle.y - radius - 8);
                        }
                    } else {
                        // 極小円用のラベル（円の外に表示）
                        ctx.fillStyle = '#1D1D1F';
                        ctx.font = '8px -apple-system, BlinkMacSystemFont, sans-serif';
                        ctx.textAlign = 'left';
                                                ctx.fillText(`${circle.activeSize}mm`, circle.x + radius + 3, circle.y + 3);
                    }
                });
            };

            const getTouchPosition = (e, canvas) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                return {
                    x: (clientX - rect.left) * (canvas.width / rect.width),
                    y: (clientY - rect.top) * (canvas.height / rect.height)
                };
            };

            const findCircleAtPosition = (x, y) => {
                const scaleFactor = getScaleFactor();
                for (let i = childCircles.length - 1; i >= 0; i--) {
                    const circle = childCircles[i];
                    const dx = x - circle.x;
                    const dy = y - circle.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const radius = Math.max(
                        MIN_VISIBLE_RADIUS,
                        (circle.activeSize * scaleFactor) / 2
                    );
                    
                    if (distance <= Math.max(radius + 5, 15)) { // 最小クリック範囲を確保
                        return i;
                    }
                }
                return null;
            };

            const handleStart = (e) => {
                e.preventDefault();
                const canvas = canvasRef.current;
                if (!canvas) return;

                const pos = getTouchPosition(e, canvas);
                const circleIndex = findCircleAtPosition(pos.x, pos.y);
                
                if (circleIndex !== null) {
                    setSelectedCircleIndex(circleIndex);
                    setDragState({
                        isDragging: false,
                        dragIndex: circleIndex,
                        startPos: pos
                    });
                } else {
                    setSelectedCircleIndex(null);
                }
            };

            const handleMove = (e) => {
                e.preventDefault();
                if (dragState.dragIndex === null) return;

                const canvas = canvasRef.current;
                if (!canvas) return;

                const pos = getTouchPosition(e, canvas);
                const deltaX = pos.x - dragState.startPos.x;
                const deltaY = pos.y - dragState.startPos.y;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

                if (!dragState.isDragging && distance > 3) {
                    setDragState(prev => ({ ...prev, isDragging: true }));
                }

                if (dragState.isDragging) {
                    const scaleFactor = getScaleFactor();
                    setChildCircles(prev => prev.map((circle, index) => {
                        if (index !== dragState.dragIndex) return circle;
                        
                        const radius = Math.max(MIN_VISIBLE_RADIUS, (circle.activeSize * scaleFactor) / 2);
                        const newX = Math.max(radius, Math.min(CANVAS_SIZE - radius, pos.x));
                        const newY = Math.max(radius, Math.min(CANVAS_SIZE - radius, pos.y));
                        
                        return { ...circle, x: newX, y: newY };
                    }));
                }
            };

            const handleEnd = (e) => {
                e.preventDefault();
                setDragState({
                    isDragging: false,
                    dragIndex: null,
                    startPos: { x: 0, y: 0 }
                });
            };

            const addNewDevice = () => {
                // バリデーション
                if (!newDeviceForm.名称 || !newDeviceForm.タイプ || !newDeviceForm.最大外径) {
                    alert('名称、タイプ、最大外径は必須項目です。');
                    return;
                }

                const maxDiameter = parseFloat(newDeviceForm.最大外径);
                const shaftDiameter = newDeviceForm.シャフト径 ? parseFloat(newDeviceForm.シャフト径) : undefined;

                if (isNaN(maxDiameter) || maxDiameter <= 0) {
                    alert('最大外径は正の数値で入力してください。');
                    return;
                }

                if (shaftDiameter !== undefined && (isNaN(shaftDiameter) || shaftDiameter <= 0)) {
                    alert('シャフト径は正の数値で入力してください。');
                    return;
                }

                // 新しいデバイスオブジェクトを作成
                const newDevice = {
                    判断円: newDeviceForm.判断円,
                    タイプ: newDeviceForm.タイプ,
                    名称: newDeviceForm.名称,
                    最大外径: maxDiameter
                };

                if (shaftDiameter) {
                    newDevice.シャフト径 = shaftDiameter;
                }

                if (newDeviceForm.備考) {
                    newDevice.備考 = newDeviceForm.備考;
                }

                // データベースに追加
                setDatabase(prev => [...prev, newDevice]);

                // フォームをリセット
                setNewDeviceForm({
                    判断円: '子円',
                    タイプ: '',
                    名称: '',
                    最大外径: '',
                    シャフト径: '',
                    備考: ''
                });

                setShowAddForm(false);
                alert(`✅ 「${newDevice.名称}」をデータベースに追加しました！`);
            };

            const startEdit = (index, item) => {
                setEditingIndex(index);
                setEditForm({
                    判断円: item.判断円,
                    タイプ: item.タイプ,
                    名称: item.名称,
                    最大外径: item.最大外径.toString(),
                    シャフト径: item.シャフト径 ? item.シャフト径.toString() : '',
                    備考: item.備考 || ''
                });
            };

            const saveEdit = (originalIndex) => {
                // バリデーション
                if (!editForm.名称 || !editForm.タイプ || !editForm.最大外径) {
                    alert('名称、タイプ、最大外径は必須項目です。');
                    return;
                }

                const maxDiameter = parseFloat(editForm.最大外径);
                const shaftDiameter = editForm.シャフト径 ? parseFloat(editForm.シャフト径) : undefined;

                if (isNaN(maxDiameter) || maxDiameter <= 0) {
                    alert('最大外径は正の数値で入力してください。');
                    return;
                }

                if (shaftDiameter !== undefined && (isNaN(shaftDiameter) || shaftDiameter <= 0)) {
                    alert('シャフト径は正の数値で入力してください。');
                    return;
                }

                // 編集されたデバイスオブジェクトを作成
                const updatedDevice = {
                    判断円: editForm.判断円,
                    タイプ: editForm.タイプ,
                    名称: editForm.名称,
                    最大外径: maxDiameter
                };

                if (shaftDiameter) {
                    updatedDevice.シャフト径 = shaftDiameter;
                }

                if (editForm.備考) {
                    updatedDevice.備考 = editForm.備考;
                }

                // データベースを更新
                setDatabase(prev => prev.map((item, index) => 
                    index === originalIndex ? updatedDevice : item
                ));

                setEditingIndex(null);
                setEditForm({});
                alert(`✅ 「${updatedDevice.名称}」を更新しました！`);
            };

            const cancelEdit = () => {
                setEditingIndex(null);
                setEditForm({});
            };

            const deleteDevice = (index, item) => {
                if (confirm(`「${item.名称}」を削除しますか？`)) {
                    setDatabase(prev => prev.filter((_, i) => i !== index));
                    alert(`✅ 「${item.名称}」を削除しました。`);
                }
            };

            const handleAddCircle = () => {
                if (!selectedParent || !selectedName) return;

                const selectedCircle = childCirclesData.find(
                    circle => circle.名称 === selectedName && circle.タイプ === selectedType
                );

                if (!selectedCircle) return;

                // 適合性チェック
                const compatibility = checkCompatibility(selectedParent, selectedCircle, selectedPattern);
                
                const diameter = selectedPattern === 'pattern1' ? selectedCircle.最大外径 : (selectedCircle.シャフト径 || selectedCircle.最大外径);
                
                const newCircle = {
                    ...selectedCircle,
                    x: CANVAS_SIZE / 2,
                    y: CANVAS_SIZE / 2,
                    pattern: selectedPattern,
                    activeSize: diameter,
                    compatibility: compatibility
                };
                
                setChildCircles(prev => [...prev, newCircle]);
                setSelectedCircleIndex(childCircles.length);
                setActiveTab('canvas');
            };

            const removeCircle = (index) => {
                setChildCircles(prev => prev.filter((_, i) => i !== index));
                if (selectedCircleIndex === index) {
                    setSelectedCircleIndex(null);
                } else if (selectedCircleIndex > index) {
                    setSelectedCircleIndex(prev => prev - 1);
                }
            };

            const togglePattern = () => {
                if (selectedCircleIndex === null) return;
                
                setChildCircles(prev => prev.map((circle, index) => {
                    if (index !== selectedCircleIndex) return circle;
                    
                    const newPattern = circle.pattern === 'pattern1' ? 'pattern2' : 'pattern1';
                    const newActiveSize = newPattern === 'pattern1' ? circle.最大外径 : (circle.シャフト径 || circle.最大外径);
                    const newCompatibility = checkCompatibility(selectedParent, circle, newPattern);
                    
                    return {
                        ...circle,
                        pattern: newPattern,
                        activeSize: newActiveSize,
                        compatibility: newCompatibility
                    };
                }));
            };

            const exportData = () => {
                const dataStr = JSON.stringify(database, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'pci_database.json';
                link.click();
                URL.revokeObjectURL(url);
            };

            const importData = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const jsonData = JSON.parse(e.target.result);
                            if (Array.isArray(jsonData)) {
                                setDatabase(jsonData);
                                alert(`✅ データのインポートが完了しました！(${jsonData.length}件)`);
                            } else {
                                alert('❌ 正しいJSON形式ではありません。');
                            }
                        } catch (error) {
                            alert('❌ ファイルの読み込みエラー: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
                // input要素をリセット（同じファイルを再選択可能にする）
                event.target.value = '';
            };

            const uniqueTypes = [...new Set(childCirclesData.map(circle => circle.タイプ))];
            const filteredByType = childCirclesData.filter(circle => circle.タイプ === selectedType);
            const selectedCircle = selectedCircleIndex !== null ? childCircles[selectedCircleIndex] : null;

            // 検索フィルタリング
            const filteredDatabase = database.filter(item => 
                item.名称.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.タイプ.toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* ヘッダー */}
                    <header className="bg-white border-b border-gray-200 sticky top-0 z-50">
                        <div className="max-w-md mx-auto px-4 py-4">
                            <div className="flex items-center justify-between mb-4">
                                <h1 className="text-2xl font-semibold text-gray-900">Circle Checker Pro</h1>
                                <div className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full font-medium">
                                    手動配置版
                                </div>
                            </div>
                            
                            {/* タブ */}
                            <div className="flex bg-gray-100 rounded-lg p-1">
                                {[
                                    { id: 'setup', label: '設定', icon: '⚙️' },
                                    { id: 'canvas', label: '配置', icon: '🎯' },
                                    { id: 'list', label: '一覧', icon: '📋' },
                                    { id: 'database', label: 'DB', icon: '🗄️' }
                                ].map(tab => (
                                    <button
                                        key={tab.id}
                                        onClick={() => setActiveTab(tab.id)}
                                        className={`flex-1 py-2 px-2 rounded-md text-xs font-medium transition-all ${
                                            activeTab === tab.id
                                                ? 'bg-white text-blue-600 shadow-sm'
                                                : 'text-gray-600 hover:text-gray-900'
                                        }`}
                                    >
                                        <div className="flex flex-col items-center space-y-1">
                                            <span>{tab.icon}</span>
                                            <span>{tab.label}</span>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </header>

                    <main className="max-w-md mx-auto px-4 py-6">

                        {/* 設定タブ */}
                        {activeTab === 'setup' && (
                            <div className="space-y-6">
                                <div className="bg-white rounded-xl p-6 shadow-sm">
                                    <h2 className="text-lg font-semibold text-gray-900 mb-4">円の設定</h2>
                                    
                                    <div className="space-y-4">
                                        {/* 親円選択 */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">親円</label>
                                            <select
                                                value={selectedParent?.名称 || ''}
                                                onChange={(e) => {
                                                    const parent = parentCircles.find(p => p.名称 === e.target.value);
                                                    setSelectedParent(parent);
                                                }}
                                                className="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base"
                                            >
                                                <option value="">選択してください</option>
                                                {parentCircles.map((circle, index) => (
                                                    <option key={index} value={circle.名称}>
                                                        {circle.タイプ} - {circle.名称} ({circle.最大外径}mm)
                                                    </option>
                                                ))}
                                            </select>
                                        </div>

                                        {/* 選択された親円の詳細情報 */}
                                        {selectedParent && (
                                            <div className="bg-gray-50 rounded-lg p-4">
                                                <h4 className="font-medium text-gray-900 mb-2">選択中の親円</h4>
                                                <div className="text-sm text-gray-700 space-y-1">
                                                    <p><strong>名称:</strong> {selectedParent.名称}</p>
                                                    <p><strong>タイプ:</strong> {selectedParent.タイプ}</p>
                                                    <p><strong>最大外径:</strong> {selectedParent.最大外径}mm</p>
                                                    {selectedParent.備考 && (
                                                        <p className="text-xs bg-yellow-100 text-yellow-800 p-2 rounded mt-2">
                                                            💡 <strong>備考:</strong> {selectedParent.備考}
                                                        </p>
                                                    )}
                                                </div>
                                            </div>
                                        )}

                                        {/* タイプ選択 */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">タイプ</label>
                                            <select
                                                value={selectedType}
                                                onChange={(e) => {
                                                    setSelectedType(e.target.value);
                                                    setSelectedName('');
                                                }}
                                                className="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base"
                                            >
                                                <option value="">選択してください</option>
                                                {uniqueTypes.map((type, index) => (
                                                    <option key={index} value={type}>{type}</option>
                                                ))}
                                            </select>
                                        </div>

                                        {/* 名称選択 */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">名称</label>
                                            <select
                                                value={selectedName}
                                                onChange={(e) => setSelectedName(e.target.value)}
                                                disabled={!selectedType}
                                                className="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 text-base"
                                            >
                                                <option value="">選択してください</option>
                                                {filteredByType.map((circle, index) => (
                                                    <option key={index} value={circle.名称}>
                                                        {circle.名称} ({circle.最大外径}mm)
                                                    </option>
                                                ))}
                                            </select>
                                        </div>

                                        {/* 選択された円の詳細情報 */}
                                        {selectedName && (() => {
                                            const selectedDetail = filteredByType.find(c => c.名称 === selectedName);
                                            return (
                                                <div className="bg-blue-50 rounded-lg p-4">
                                                    <h4 className="font-medium text-blue-900 mb-2">詳細情報</h4>
                                                    <div className="text-sm text-blue-800 space-y-1">
                                                        <p><strong>最大外径:</strong> {selectedDetail?.最大外径}mm</p>
                                                        {selectedDetail?.シャフト径 && (
                                                            <p><strong>シャフト径:</strong> {selectedDetail.シャフト径}mm</p>
                                                        )}
                                                        {selectedDetail?.備考 && (
                                                            <p className="text-xs bg-yellow-100 text-yellow-800 p-2 rounded mt-2">
                                                                💡 {selectedDetail.備考}
                                                            </p>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })()}

                                        {/* パターン選択 */}
                                        {selectedName && (
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">直径パターン</label>
                                                <div className="flex space-x-3">
                                                    <label className="flex-1">
                                                        <input
                                                            type="radio"
                                                            name="pattern"
                                                            value="pattern1"
                                                            checked={selectedPattern === 'pattern1'}
                                                            onChange={(e) => setSelectedPattern(e.target.value)}
                                                            className="sr-only"
                                                        />
                                                        <div className={`p-4 border-2 rounded-lg text-center cursor-pointer transition-all ${
                                                            selectedPattern === 'pattern1'
                                                                ? 'border-blue-500 bg-blue-50 text-blue-700'
                                                                : 'border-gray-300 text-gray-700 hover:border-gray-400'
                                                        }`}>
                                                            <div className="text-xl mb-2">🔵</div>
                                                            <div className="text-sm font-medium">最大外径</div>
                                                            <div className="text-xs text-gray-600">
                                                                {filteredByType.find(c => c.名称 === selectedName)?.最大外径}mm
                                                            </div>
                                                        </div>
                                                    </label>
                                                    <label className="flex-1">
                                                        <input
                                                            type="radio"
                                                            name="pattern"
                                                            value="pattern2"
                                                            checked={selectedPattern === 'pattern2'}
                                                            onChange={(e) => setSelectedPattern(e.target.value)}
                                                            className="sr-only"
                                                        />
                                                        <div className={`p-4 border-2 rounded-lg text-center cursor-pointer transition-all ${
                                                            selectedPattern === 'pattern2'
                                                                ? 'border-green-500 bg-green-50 text-green-700'
                                                                : 'border-gray-300 text-gray-700 hover:border-gray-400'
                                                        }`}>
                                                            <div className="text-xl mb-2">🟢</div>
                                                            <div className="text-sm font-medium">シャフト径</div>
                                                            <div className="text-xs text-gray-600">
                                                                {filteredByType.find(c => c.名称 === selectedName)?.シャフト径 || 'N/A'}mm
                                                            </div>
                                                        </div>
                                                    </label>
                                                </div>
                                            </div>
                                        )}

                                        <button
                                            onClick={handleAddCircle}
                                            disabled={!selectedParent || !selectedName}
                                            className="w-full py-4 px-4 rounded-lg font-medium text-lg transition-colors bg-blue-500 hover:bg-blue-600 text-white disabled:bg-gray-300 disabled:cursor-not-allowed"
                                        >
                                            円を追加
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 配置タブ */}
                        {activeTab === 'canvas' && (
                            <div className="space-y-6">
                                <div className="bg-white rounded-xl p-6 shadow-sm">
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-lg font-semibold text-gray-900">配置図</h2>
                                        {childCircles.length > 0 && (
                                            <span className="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded-full">
                                                {childCircles.length}個
                                            </span>
                                        )}
                                    </div>
                                    
                                    <div className="flex justify-center mb-4 relative">
                                        {/* 正確表示インジケーター */}
                                        <div className="accurate-indicator">
                                            📏 正確サイズ
                                        </div>

                                        <canvas
                                            ref={canvasRef}
                                            onTouchStart={handleStart}
                                            onTouchMove={handleMove}
                                            onTouchEnd={handleEnd}
                                            onMouseDown={handleStart}
                                            onMouseMove={handleMove}
                                            onMouseUp={handleEnd}
                                            onMouseLeave={handleEnd}
                                            className="border border-gray-200 rounded-lg bg-white cursor-pointer touch-none"
                                            style={{ maxWidth: '100%', height: 'auto' }}
                                        />
                                    </div>

                                    {childCircles.length === 0 && (
                                        <div className="text-center py-8">
                                            <div className="text-4xl mb-2">⭕</div>
                                            <p className="text-gray-500 text-sm mb-2">設定タブで円を追加してください</p>
                                            <p className="text-gray-400 text-xs">円をタップして選択・ドラッグで移動</p>
                                            <div className="mt-4 p-3 bg-blue-50 rounded-lg text-xs text-blue-800">
                                                🎯 手動で円を配置して重なりを確認できます
                                            </div>
                                        </div>
                                    )}
                                    
                                </div>

                                {/* コントロール */}
                                {selectedCircle && (
                                    <div className="bg-white rounded-xl p-6 shadow-sm">
                                        <h3 className="text-lg font-semibold text-gray-900 mb-4">選択中の円</h3>
                                        <div className="bg-gray-50 rounded-lg p-4 mb-4">
                                            <p className="font-medium text-gray-900">{selectedCircle.名称.split('【')[0]}</p>
                                            <p className="text-sm text-gray-600">
                                                {selectedCircle.pattern === 'pattern1' ? '最大外径' : 'シャフト径'}: {selectedCircle.activeSize}mm
                                            </p>
                                            
                                            {/* 適合性表示（リアルタイム重なり検出） */}
                                            {(() => {
                                                const circlesWithOverlapInfo = detectOverlaps(childCircles);
                                                const currentCircleInfo = circlesWithOverlapInfo[selectedCircleIndex];
                                                
                                                if (!currentCircleInfo) return null;

                                                let statusMessage, statusColor;
                                                if (currentCircleInfo.isOutsideParent) {
                                                    statusMessage = '⚠️ 親円からはみ出し';
                                                    statusColor = 'bg-red-100 text-red-800';
                                                } else if (currentCircleInfo.hasCircleOverlap) {
                                                    statusMessage = '⚠️ 子円同士が重なり';
                                                    statusColor = 'bg-orange-100 text-orange-800';
                                                } else if (currentCircleInfo.compatibility.status === 'DANGER') {
                                                    statusMessage = '⚠️ 適合性危険';
                                                    statusColor = 'bg-red-100 text-red-800';
                                                } else if (currentCircleInfo.compatibility.status === 'WARNING') {
                                                    statusMessage = '⚠️ 適合性注意';
                                                    statusColor = 'bg-yellow-100 text-yellow-800';
                                                } else {
                                                    statusMessage = '✅ 正常';
                                                    statusColor = 'bg-green-100 text-green-800';
                                                }

                                                return (
                                                    <div className={`mt-2 p-2 rounded text-xs ${statusColor}`}>
                                                        {statusMessage}
                                                    </div>
                                                );
                                            })()}
                                            
                                            {selectedCircle.備考 && (
                                                <p className="text-xs text-yellow-700 bg-yellow-100 p-2 rounded mt-2">
                                                    💡 {selectedCircle.備考}
                                                </p>
                                            )}
                                        </div>

                                        <div className="flex space-x-3">
                                            <button 
                                                onClick={togglePattern} 
                                                className="flex-1 bg-blue-100 hover:bg-blue-200 text-blue-700 py-4 px-4 rounded-lg font-medium transition-colors"
                                            >
                                                パターン切替
                                            </button>
                                            <button
                                                onClick={() => removeCircle(selectedCircleIndex)}
                                                className="bg-red-500 hover:bg-red-600 text-white py-4 px-4 rounded-lg font-medium transition-colors"
                                            >
                                                削除
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* 一覧タブ */}
                        {activeTab === 'list' && (
                            <div className="space-y-4">
                                <div className="flex items-center justify-between">
                                    <h2 className="text-lg font-semibold text-gray-900">配置済み円一覧</h2>
                                    {childCircles.length > 0 && (
                                        <span className="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded-full">
                                            {childCircles.length}個
                                        </span>
                                    )}
                                </div>

                                {childCircles.length === 0 ? (
                                    <div className="bg-white rounded-xl p-8 shadow-sm text-center">
                                        <div className="text-4xl mb-2">📋</div>
                                        <p className="text-gray-500 mb-4">まだ円が配置されていません</p>
                                        <button
                                            onClick={() => setActiveTab('setup')}
                                            className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
                                        >
                                            設定タブで追加
                                        </button>
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {(() => {
                                            const circlesWithOverlapInfo = detectOverlaps(childCircles);
                                            
                                            return circlesWithOverlapInfo.map((circle, index) => {
                                                // 状態に応じた色とメッセージ
                                                let borderColor, bgColor, statusMessage;
                                                if (circle.isOutsideParent) {
                                                    borderColor = 'border-red-600';
                                                    bgColor = 'bg-red-100';
                                                    statusMessage = '⚠️ 親円からはみ出し';
                                                } else if (circle.hasCircleOverlap) {
                                                    borderColor = 'border-orange-400';
                                                    bgColor = 'bg-orange-100';
                                                    statusMessage = '⚠️ 子円同士が重なり';
                                                } else if (circle.compatibility.status === 'DANGER') {
                                                    borderColor = 'border-red-500';
                                                    bgColor = 'bg-red-50';
                                                    statusMessage = '⚠️ 適合性危険';
                                                } else if (circle.compatibility.status === 'WARNING') {
                                                    borderColor = 'border-yellow-500';
                                                    bgColor = 'bg-yellow-50';
                                                    statusMessage = '⚠️ 適合性注意';
                                                } else {
                                                    borderColor = 'border-green-500';
                                                    bgColor = '';
                                                    statusMessage = '✅ 正常';
                                                }

                                                return (
                                                    <div
                                                        key={index}
                                                        onClick={() => {
                                                            setSelectedCircleIndex(index);
                                                            setActiveTab('canvas');
                                                        }}
                                                        className={`bg-white rounded-xl p-4 shadow-sm cursor-pointer transition-all border-l-4 ${borderColor} ${bgColor} ${index === selectedCircleIndex ? 'ring-2 ring-blue-500' : 'hover:shadow-md'}`}
                                                    >
                                                        <div className="flex items-center justify-between">
                                                            <div className="flex-1">
                                                                <h3 className="font-medium text-gray-900">{circle.名称.split('【')[0]}</h3>
                                                                <p className="text-sm text-gray-600">{circle.タイプ}</p>
                                                                <p className="text-sm text-blue-600">
                                                                    {circle.pattern === 'pattern1' ? '最大外径' : 'シャフト径'}: {circle.activeSize}mm
                                                                </p>
                                                                <p className={`text-xs mt-1 font-medium ${
                                                                    circle.isOutsideParent || circle.hasCircleOverlap ? 'text-red-600' :
                                                                    circle.compatibility.status === 'DANGER' ? 'text-red-600' :
                                                                    circle.compatibility.status === 'WARNING' ? 'text-yellow-600' :
                                                                    'text-green-600'
                                                                }`}>
                                                                    {statusMessage}
                                                                </p>
                                                                {circle.備考 && (
                                                                    <p className="text-xs text-yellow-700 bg-yellow-100 p-1 rounded mt-1">
                                                                        💡 {circle.備考.substring(0, 30)}...
                                                                    </p>
                                                                )}
                                                            </div>
                                                            <div className="flex items-center space-x-2">
                                                                <span className={`w-3 h-3 rounded-full ${
                                                                    circle.pattern === 'pattern1' ? 'bg-blue-500' : 'bg-green-500'
                                                                }`}></span>
                                                                {index === selectedCircleIndex && (
                                                                    <span className="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">選択中</span>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            });
                                        })()}
                                        
                                        {childCircles.length > 0 && (
                                            <button
                                                onClick={() => {
                                                    if (confirm(`配置済みの${childCircles.length}個の円をすべて削除しますか？`)) {
                                                        setChildCircles([]);
                                                        setSelectedCircleIndex(null);
                                                    }
                                                }}
                                                className="w-full py-3 px-4 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors"
                                            >
                                                すべて削除
                                            </button>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* データベースタブ */}
                        {activeTab === 'database' && (
                            <div className="bg-white rounded-xl p-6 shadow-sm">
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="text-lg font-semibold text-gray-900">データベース管理</h2>
                                    <span className="bg-green-100 text-green-800 text-xs font-medium px-2 py-1 rounded-full">
                                        {database.length}件
                                    </span>
                                </div>

                                {/* 検索・管理ボタン */}
                                <div className="mb-4">
                                    <input
                                        type="text"
                                        placeholder="名称やタイプで検索..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        className="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base mb-3"
                                    />
                                    
                                    <div className="flex space-x-2">
                                        <button
                                            onClick={() => setShowAddForm(true)}
                                            className="flex-1 py-2 px-3 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600 transition-colors"
                                        >
                                            ➕ 新規追加
                                        </button>
                                        <button
                                            onClick={exportData}
                                            className="flex-1 py-2 px-3 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600 transition-colors"
                                        >
                                            📤 エクスポート
                                        </button>
                                        <label className="flex-1 py-2 px-3 bg-purple-500 text-white rounded-lg text-sm hover:bg-purple-600 transition-colors cursor-pointer text-center">
                                            📥 インポート
                                            <input
                                                type="file"
                                                accept=".json"
                                                onChange={importData}
                                                className="hidden"
                                            />
                                        </label>
                                    </div>
                                </div>

                                {/* 新規デバイス追加フォーム */}
                                {showAddForm && (
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                        <div className="flex items-center justify-between mb-4">
                                            <h4 className="font-medium text-blue-800">新しいデバイスを追加</h4>
                                            <button
                                                onClick={() => setShowAddForm(false)}
                                                className="text-blue-600 hover:text-blue-800"
                                            >
                                                ✕
                                            </button>
                                        </div>
                                        
                                        <div className="space-y-3">
                                            <div className="grid grid-cols-2 gap-2">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">判断円</label>
                                                    <select
                                                        value={newDeviceForm.判断円}
                                                        onChange={(e) => setNewDeviceForm(prev => ({ ...prev, 判断円: e.target.value }))}
                                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                                    >
                                                        <option value="親円">親円</option>
                                                        <option value="子円">子円</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">タイプ *</label>
                                                    <input
                                                        type="text"
                                                        value={newDeviceForm.タイプ}
                                                        onChange={(e) => setNewDeviceForm(prev => ({ ...prev, タイプ: e.target.value }))}
                                                        placeholder="バルーン〔SC〕"
                                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                                    />
                                                </div>
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">名称 *</label>
                                                <input
                                                    type="text"
                                                    value={newDeviceForm.名称}
                                                    onChange={(e) => setNewDeviceForm(prev => ({ ...prev, 名称: e.target.value }))}
                                                    placeholder="Ryurei【2.50-3.50mm】"
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                                />
                                            </div>

                                            <div className="grid grid-cols-2 gap-2">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">最大外径(mm) *</label>
                                                    <input
                                                        type="number"
                                                        step="0.001"
                                                        value={newDeviceForm.最大外径}
                                                        onChange={(e) => setNewDeviceForm(prev => ({ ...prev, 最大外径: e.target.value }))}
                                                        placeholder="0.87"
                                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                                    />
                                                </div>
                                                {newDeviceForm.判断円 === '子円' && (
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-1">シャフト径(mm)</label>
                                                        <input
                                                            type="number"
                                                            step="0.001"
                                                            value={newDeviceForm.シャフト径}
                                                            onChange={(e) => setNewDeviceForm(prev => ({ ...prev, シャフト径: e.target.value }))}
                                                            placeholder="0.64"
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                                        />
                                                    </div>
                                                )}
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">備考</label>
                                                <input
                                                    type="text"
                                                    value={newDeviceForm.備考}
                                                    onChange={(e) => setNewDeviceForm(prev => ({ ...prev, 備考: e.target.value }))}
                                                    placeholder="適応GC :6Fr"
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                                />
                                            </div>

                                            <div className="flex space-x-2 pt-2">
                                                <button
                                                    onClick={addNewDevice}
                                                    className="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg font-medium transition-colors text-sm"
                                                >
                                                    追加
                                                </button>
                                                <button
                                                    onClick={() => setShowAddForm(false)}
                                                    className="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-medium transition-colors text-sm"
                                                >
                                                    キャンセル
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* データリスト */}
                                <div className="space-y-2">
                                    {filteredDatabase.map((item, originalIndex) => {
                                        const actualIndex = database.findIndex(dbItem => 
                                            dbItem.名称 === item.名称 && 
                                            dbItem.タイプ === item.タイプ && 
                                            dbItem.最大外径 === item.最大外径
                                        );
                                        
                                        const isEditing = editingIndex === actualIndex;
                                        
                                        return (
                                            <div key={`${actualIndex}-${item.名称}`} className={`border rounded-lg p-3 ${isEditing ? 'ring-2 ring-blue-500 border-blue-300' : 'border-gray-200 hover:border-gray-300'} transition-all`}>
                                                {isEditing ? (
                                                    /* 編集フォーム */
                                                    <div className="space-y-3">
                                                        <div className="flex items-center justify-between mb-2">
                                                            <h4 className="font-medium text-blue-800 text-sm">データを編集</h4>
                                                            <button
                                                                onClick={cancelEdit}
                                                                className="text-gray-600 hover:text-gray-800 text-sm"
                                                            >
                                                                ✕
                                                            </button>
                                                        </div>
                                                        
                                                        <div className="grid grid-cols-2 gap-2">
                                                            <div>
                                                                <label className="block text-xs font-medium text-gray-700 mb-1">判断円</label>
                                                                <select
                                                                    value={editForm.判断円}
                                                                    onChange={(e) => setEditForm(prev => ({ ...prev, 判断円: e.target.value }))}
                                                                    className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                                                                >
                                                                    <option value="親円">親円</option>
                                                                    <option value="子円">子円</option>
                                                                </select>
                                                            </div>
                                                            <div>
                                                                <label className="block text-xs font-medium text-gray-700 mb-1">タイプ *</label>
                                                                <input
                                                                    type="text"
                                                                    value={editForm.タイプ}
                                                                    onChange={(e) => setEditForm(prev => ({ ...prev, タイプ: e.target.value }))}
                                                                    className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                                                                />
                                                            </div>
                                                        </div>
                                                        
                                                        <div>
                                                            <label className="block text-xs font-medium text-gray-700 mb-1">名称 *</label>
                                                            <input
                                                                type="text"
                                                                value={editForm.名称}
                                                                onChange={(e) => setEditForm(prev => ({ ...prev, 名称: e.target.value }))}
                                                                className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                                                            />
                                                        </div>
                                                        
                                                        <div className="grid grid-cols-2 gap-2">
                                                            <div>
                                                                <label className="block text-xs font-medium text-gray-700 mb-1">最大外径(mm) *</label>
                                                                <input
                                                                    type="number"
                                                                    step="0.001"
                                                                    value={editForm.最大外径}
                                                                    onChange={(e) => setEditForm(prev => ({ ...prev, 最大外径: e.target.value }))}
                                                                    className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                                                                />
                                                            </div>
                                                            {editForm.判断円 === '子円' && (
                                                                <div>
                                                                    <label className="block text-xs font-medium text-gray-700 mb-1">シャフト径(mm)</label>
                                                                    <input
                                                                        type="number"
                                                                        step="0.001"
                                                                        value={editForm.シャフト径}
                                                                        onChange={(e) => setEditForm(prev => ({ ...prev, シャフト径: e.target.value }))}
                                                                        className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                                                                    />
                                                                </div>
                                                            )}
                                                        </div>
                                                        
                                                        <div>
                                                            <label className="block text-xs font-medium text-gray-700 mb-1">備考</label>
                                                            <input
                                                                type="text"
                                                                value={editForm.備考}
                                                                onChange={(e) => setEditForm(prev => ({ ...prev, 備考: e.target.value }))}
                                                                className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                                                            />
                                                        </div>
                                                        
                                                        <div className="flex space-x-2 pt-2">
                                                            <button
                                                                onClick={() => saveEdit(actualIndex)}
                                                                className="flex-1 bg-green-500 hover:bg-green-600 text-white py-1 px-3 rounded font-medium transition-colors text-xs"
                                                            >
                                                                保存
                                                            </button>
                                                            <button
                                                                onClick={cancelEdit}
                                                                className="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-1 px-3 rounded font-medium transition-colors text-xs"
                                                            >
                                                                キャンセル
                                                            </button>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    /* 通常表示 */
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex-1">
                                                            <div className="flex items-center space-x-2 mb-1">
                                                                <span className={`w-2 h-2 rounded-full ${
                                                                    item.判断円 === '親円' ? 'bg-blue-500' : 'bg-green-500'
                                                                }`}></span>
                                                                <span className="font-medium text-sm">{item.名称}</span>
                                                            </div>
                                                            <div className="text-xs text-gray-600 space-y-0.5">
                                                                <p><span className="font-medium">タイプ:</span> {item.タイプ}</p>
                                                                <p>
                                                                    <span className="font-medium">最大外径:</span> {item.最大外径}mm
                                                                    {item.シャフト径 && <span className="ml-2"><span className="font-medium">シャフト径:</span> {item.シャフト径}mm</span>}
                                                                </p>
                                                                {item.備考 && (
                                                                    <p className="text-yellow-700 bg-yellow-100 p-1 rounded">
                                                                        <span className="font-medium">備考:</span> {item.備考}
                                                                    </p>
                                                                )}
                                                            </div>
                                                        </div>
                                                        <div className="flex items-center space-x-1 ml-2">
                                                            <button
                                                                onClick={() => startEdit(actualIndex, item)}
                                                                className="bg-blue-500 hover:bg-blue-600 text-white p-1.5 rounded text-xs font-bold"
                                                                title="編集"
                                                            >
                                                                ✏️
                                                            </button>
                                                            <button
                                                                onClick={() => deleteDevice(actualIndex, item)}
                                                                className="bg-red-500 hover:bg-red-600 text-white p-1.5 rounded text-xs font-bold"
                                                                title="削除"
                                                            >
                                                                🗑️
                                                            </button>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>

                                {filteredDatabase.length === 0 && searchTerm && (
                                    <div className="text-center py-8">
                                        <div className="text-2xl mb-2">🔍</div>
                                        <p className="text-gray-500 text-sm">検索結果が見つかりません</p>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        ReactDOM.render(<CircleCheckerPro />, document.getElementById('root'));
    </script>
</body>
